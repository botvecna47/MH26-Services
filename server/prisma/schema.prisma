generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(uuid())
  name                   String
  email                  String                  @unique
  phone                  String?
  passwordHash           String
  avatarUrl              String?
  role                   UserRole                @default(CUSTOMER)
  emailVerified          Boolean                 @default(false)
  isBanned               Boolean                 @default(false)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  address                String?
  city                   String?
  totalSpending          Decimal                 @default(0)
  walletBalance          Decimal                 @default(0)
  reviewedAppeals        Appeal[]                @relation("AppealReviewer")
  appeals                Appeal[]                @relation("UserAppeals")
  auditLogs              AuditLog[]              @relation("userAudit")
  bookings               Booking[]
  emailVerificationToken EmailVerificationToken?
  messagesReceived       Message[]               @relation("messages_received")
  messagesSent           Message[]               @relation("messages_sent")
  notifications          Notification[]
  passwordResetTokens    PasswordResetToken[]
  provider               Provider?
  refreshTokens          RefreshToken[]
  reports                Report[]
  reviews                Review[]
  savedProviders         SavedProvider[]
  transactions           Transaction[]
  verifiedProviders      Provider[]              @relation("ProviderVerifier")

  @@index([email])
  @@index([phone])
  @@index([role])
}

model Provider {
  id                String             @id @default(uuid())
  userId            String             @unique
  businessName      String
  description       String?
  primaryCategory   String
  secondaryCategory String?
  address           String
  city              String
  state             String             @default("Maharashtra")
  pincode           String
  lat               Float?
  lng               Float?
  averageRating     Float?             @default(0)
  totalRatings      Int                @default(0)
  status            ProviderStatus     @default(PENDING)
  qrCodeUrl         String?
  gallery           String[]           @default([])
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  availability      Json?
  serviceRadius     Int                @default(10)
  totalRevenue      Decimal            @default(0)
  aadharPanUrl      String?
  adminNotes        String?
  insuranceInfo     String?
  portfolioUrls     String[]           @default([])
  rejectionReason   String?
  socialMediaLinks  Json?
  termsAccepted     Boolean            @default(false)
  termsAcceptedAt   DateTime?
  verifiedById      String?            // Admin who verified
  verifiedAt        DateTime?          // When verification happened
  verifiedBy        User?              @relation("ProviderVerifier", fields: [verifiedById], references: [id])
  appeals           Appeal[]
  bookings          Booking[]
  payouts           Payout[]
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents         ProviderDocument[]
  reports           Report[]
  reviews           Review[]
  savedBy           SavedProvider[]
  services          Service[]

  @@index([city, primaryCategory])
  @@index([status])
  @@index([userId])
  @@index([lat, lng])
}

model ProviderDocument {
  id         String   @id @default(uuid())
  providerId String
  type       String
  url        String
  filename   String
  uploadedAt DateTime @default(now())
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
}

model Service {
  id                String        @id @default(uuid())
  providerId        String
  description       String?
  imageUrl          String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  basePrice         Float
  category          String
  estimatedDuration Int
  isActive          Boolean       @default(true)
  name              String
  priceUnit         String        @default("per service")
  status            ServiceStatus @default(PENDING)
  bookings          Booking[]
  provider          Provider      @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, name])
  @@index([providerId])
  @@index([category])
}

model Booking {
  id               String               @id @default(uuid())
  userId           String
  providerId       String
  serviceId        String
  scheduledAt      DateTime
  status           BookingStatus        @default(PENDING)
  paymentStatus    PaymentStatus        @default(PENDING)
  totalAmount      Decimal
  platformFee      Decimal
  providerEarnings Decimal
  address          String?
  city             String?
  pincode          String?
  requirements     String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  completionOtp    String?
  provider         Provider             @relation(fields: [providerId], references: [id], onDelete: Cascade)
  service          Service              @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  cancellation     BookingCancellation?
  review           Review?
  transaction      Transaction?

  @@index([userId, status])
  @@index([providerId, scheduledAt])
  @@index([status])
  @@index([scheduledAt])
  @@index([status, scheduledAt])
  @@index([createdAt])
}

model BookingCancellation {
  id          String   @id @default(uuid())
  bookingId   String   @unique
  cancelledBy String
  reason      String?
  createdAt   DateTime @default(now())
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

model Transaction {
  id               String            @id @default(uuid())
  userId           String
  bookingId        String?           @unique
  amount           Decimal
  currency         String            @default("INR")
  gateway          String            @default("razorpay")
  gatewayOrderId   String?
  gatewayPaymentId String?
  status           TransactionStatus @default(PENDING)
  metadata         Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  booking          Booking?          @relation(fields: [bookingId], references: [id])
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookingId])
  @@index([status])
  @@index([gatewayOrderId])
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderId       String
  receiverId     String
  text           String?
  attachments    Json?
  read           Boolean  @default(false)
  createdAt      DateTime @default(now())
  receiver       User     @relation("messages_received", fields: [receiverId], references: [id], onDelete: Cascade)
  sender         User     @relation("messages_sent", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([receiverId])
  @@index([read])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  body      String
  payload   Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read, createdAt])
  @@index([type])
}

model Review {
  id         String   @id @default(uuid())
  bookingId  String?  @unique
  providerId String
  userId     String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  booking    Booking? @relation(fields: [bookingId], references: [id])
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([userId])
  @@index([rating])
}

model Report {
  id          String       @id @default(uuid())
  reporterId  String
  providerId  String
  reason      String
  details     String?
  attachments Json?
  status      ReportStatus @default(OPEN)
  adminNotes  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  resolvedAt  DateTime?
  provider    Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  reporter    User         @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([status])
  @@index([reporterId])
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @unique
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@index([userId])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  action    String
  tableName String
  recordId  String?
  oldData   Json?
  newData   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      User?    @relation("userAudit", fields: [userId], references: [id])

  @@index([userId])
  @@index([tableName, recordId])
  @@index([createdAt])
}

model Payout {
  id         String       @id @default(uuid())
  providerId String
  amount     Decimal
  status     PayoutStatus @default(PENDING)
  gatewayRef String?
  metadata   Json?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  provider   Provider     @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([providerId])
  @@index([status])
}

model SavedProvider {
  id         String   @id @default(uuid())
  userId     String
  providerId String
  createdAt  DateTime @default(now())
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, providerId])
  @@index([userId])
}

model Appeal {
  id         String       @id @default(uuid())
  userId     String?
  providerId String?
  type       AppealType
  reason     String
  details    String?
  status     AppealStatus @default(PENDING)
  adminNotes String?
  reviewedBy String?
  reviewedAt DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  provider   Provider?    @relation(fields: [providerId], references: [id], onDelete: Cascade)
  reviewer   User?        @relation("AppealReviewer", fields: [reviewedBy], references: [id])
  user       User?        @relation("UserAppeals", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([providerId])
  @@index([status])
  @@index([type])
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  imageUrl    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
}

enum UserRole {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum ProviderStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum ServiceStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  REJECTED
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ReportStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  DISMISSED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AppealType {
  UNBAN_REQUEST
  REJECTION_APPEAL
  SUSPENSION_APPEAL
  OTHER
}

enum AppealStatus {
  PENDING
  APPROVED
  REJECTED
  UNDER_REVIEW
}
